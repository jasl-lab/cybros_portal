<%- content_for :action_bar do %>
  <ol>
    <li class="action_bar-item">
      <%= link_to t('.actions.view_deptcode_sum'),
          report_contract_hold_path(month_name: @month_name, view_deptcode_sum: true), class: 'btn text-primary' %>
    </li>
    <li class="action_bar-item">
      <%= link_to t('.actions.view_deptcode'),
          report_contract_hold_path(month_name: @month_name), class: 'btn text-primary' %>
    </li>
    <li class="action_bar-item">
      <%= link_to t('.actions.export_unsign_detail'), export_unsign_detail_report_contract_hold_path(month_name: @month_name, format: :csv), class: 'btn text-primary' %>
    </li>
    <li class="action_bar-item">
      <%= link_to t('.actions.export_sign_detail'), export_sign_detail_report_contract_hold_path(month_name: @month_name, format: :csv), class: 'btn text-primary' %>
    </li>
  </ol>
  <div class="toast" style="position: fixed; right: 10px; top: 60px; z-index: 1">
    <div class="toast-header bg-primary">
      <strong class="mr-auto">Cybros</strong>
    </div>
    <div class="toast-body bg-secondary" id="toast-message"></div>
  </div>
<% end %>

<div class="row">
  <div class="col-lg-12">
    <h3 class="page-title">
      <%= t(".title") %>
    </h3>
    <div class="row">
      <div class="col-lg-12">
        <%= form_tag report_contract_hold_path, method: :get, class: 'form-inline' do -%>
          <%= hidden_field_tag :view_deptcode_sum, @view_deptcode_sum %>
          <div class="form-group mr-3">
            <label class="mr-1"><%= t(".month_name") -%>：</label>
            <%= select_tag 'month_name', options_for_select(@all_month_names, @month_name), class: 'form-control' %>
          </div>
          <div class="form-group mr-3">
            <label class="mr-1"><%= t(".dept_names") -%>：</label>
              <%= select_tag 'depts', options_for_select(@department_options, @dept_options), {include_blank: true, multiple: true, class: 'form-control' } %>
          </div>
          <% if params[:in_iframe].present? %>
            <%= hidden_field_tag :in_iframe, true -%>
          <% end %>
          <div>
            <%= submit_tag t(".confirm"), class: 'btn btn-primary' %>
          </div>
        <% end -%>
        <h5 class="text-center">至<%= @last_available_date.year -%>年至<%= @last_available_date.month -%>月,上海天华 业务保有量为<%= (@biz_retent_totals_sum/10000.0).round(2) -%>亿元,人均业务保有量为<%= @biz_retent_totals_sum_per_staff.round(0) -%>万元。</h5>
        <div
          data-controller="contract-holds"
          data-action="resize@window->contract-holds#layout"
          data-contract-holds-x_axis="<%= @deptnames_in_order.to_json -%>"
          data-contract-holds-dept_code="<%= @only_have_data_dept.to_json -%>"
          data-contract-holds-biz_retent_contract="<%= @biz_retent_contract.to_json -%>"
          data-contract-holds-biz_retent_no_contract="<%= @biz_retent_no_contract.to_json -%>"
          data-contract-holds-biz_retent_totals="<%= @biz_retent_totals.to_json -%>"
          data-contract-holds-biz_retent_totals_per_dept="<%= @biz_retent_totals_per_dept.to_json -%>">
          <div id="contract-hold-chart" style="width: 100%; height: 450px;"></div>
          <div id="contract-hold-per-dept-chart" style="width: 100%; height: 450px;"></div>
        </div>
      </div>
    </div>
    <div class="row mt-3">
      <div class="col-lg-12">
        <table class="table table-striped table-responsive table-dark">
          <thead>
            <tr class="d-flex">
              <th scope="col" class="col-1">部门</th>
              <% @deptnames_in_order.each do |dept_name| %>
                <th scope="col" class="col-1"><%= dept_name -%></th>
              <% end %>
            </tr>
          </thead>
          <% total_staff_num = 0 %>
          <tbody>
            <tr class="d-flex">
              <th scope="row" class="col-1">平均人数</th>
              <% @dept_avg_staff.each do |staff_count| %>
                <% total_staff_num += (staff_count || 0) %>
                <td class="col-1"><%= staff_count&.round(0) -%></td>
              <% end %>
            </tr>
          </tbody>
        </table>
        <h6>表格上的总人数：<%= total_staff_num.round(0) -%></h6>
      </div>
    </div>
    <div class="row mt-3">
      <div class="col-lg-12">
        <p>业务保有量=业务保有量（已签约）+业务保有量（未签约）；</p>
        <p>业务保有量（已签约）=已归档合同的部门策划产值-部门完成产值（用项目进度计算）；</p>
        <p>业务保有量（未签约）=流转中合同的策划产值-项目完成产值（用工时人力成本计算）。</p>
      </div>
    </div>
  </div>
</div>

<div id="contract-hold-modal" class="modal" tabindex="-1" role="dialog"></div>
