<div class="row"
  data-controller="crm-year-report"
  data-action="resize@window->crm-year-report#layout"
  data-crm-year-report-x_axis="<%= @years.to_json -%>"
  data-crm-year-report-top20s="<%= @top20s.to_json -%>"
  data-crm-year-report-top20to50s="<%= @top20to50s.to_json -%>"
  data-crm-year-report-gt50s="<%= @gt50s.to_json -%>"
  data-crm-year-report-others="<%= @others.to_json -%>">
  <div class="col-12">
    <h3 class="page-title">
      <%= t(".title") %>
    </h3>
    <%= form_tag report_crm_year_report_path, method: :get, class: 'form-inline' do -%>
      <%= hidden_field_tag 'year', @year -%>
      <div class="form-group mr-1">
        <label class="mr-1"><%= t(".org_names") -%>：</label>
        <%= select_tag 'orgs', options_for_select(@organization_options, @orgs_options), { include_blank: true, multiple: true, class: 'form-control' } %>
      </div>
      <div><%= submit_tag t(".confirm"), class: 'btn btn-thape-color' %></div>
    <% end -%>
  </div>
  <div class="col-6">
    <div id="crm-year-report-chart" style="width: 100%;height: 370px;">
    </div>
  </div>
  <div class="col-6 table-responsive">
    <table class="table table-striped mt-5">
      <thead>
        <tr>
          <th class="py-3"></th>
          <th class="py-3"><%= t('.table.top20') -%></th>
          <th class="py-3"><%= t('.table.top20to50') -%></th>
          <th class="py-3"><%= t('.table.gt50') -%></th>
          <th class="py-3"><%= t('.table.other') -%></th>
          <th class="py-3"><%= t('.table.total') -%></th>
        </tr>
      </thead>
      <tbody>
        <% @data.each do |d| %>
          <tr>
            <td class="py-3"><%= d.year -%></td>
            <td class="py-3"><%= (d.top20 / 100_0000.0).round(1) -%></td>
            <td class="py-3"><%= (d.top20to50 / 100_0000.0).round(1) -%></td>
            <td class="py-3"><%= (d.gt50 / 100_0000.0).round(1) -%></td>
            <td class="py-3"><%= (d.others / 100_0000.0).round(1) -%></td>
            <td class="py-3"><%= ((d.top20+d.top20to50+d.gt50+d.others) / 100_0000.0).round(1) -%></td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
  <div class="col-12 overflow-auto" style="height: 89vh;">
    <%= form_tag report_crm_year_report_path, method: :get, class: 'form-inline' do -%>
      <%= hidden_field_tag 'orgs', @orgs_options -%>
      <div class="form-group mr-1">
        <label class="mr-1"><%= t(".year") -%>：</label>
        <%= select_tag 'year', options_for_select(@all_years, @year), { class: 'form-control form-control-plain', id: 'select-year' } %>
      </div>
      <div><%= submit_tag t(".confirm"), class: 'btn btn-thape-color' %></div>
    <% end -%>
    <table class="table table-bordered mt-2 position-relative">
      <thead>
        <tr class="table-fix-head-row-1">
          <th rowspan="2"><%= t('.table.index') -%></th>
          <th rowspan="2"><%= t('.table.customer_group') -%></th>
          <th rowspan="2"><%= t('.table.kerrey_trading_area_ranking') -%></th>
          <th rowspan="2"><%= t('.table.customer_ownership') -%></th>
          <th colspan="2"><%= t('.table.production_contract_value') -%></th>
          <th rowspan="2"><%= t('.table.total_contract_value_of_the_group_percent') -%></th>
          <th rowspan="2"><%= t('.table.the_top_three_teams_in_cooperation') -%></th>
          <th colspan="3"><%= t('.table.production_contract_value_at_each_stage') -%></th>
          <th rowspan="2"><%= t('.table.average_contract_value_of_single_project_in_the_past_year') -%></th>
          <th rowspan="2"><%= t('.table.average_scale_of_single_project_in_the_past_year') -%></th>
          <th rowspan="2"><%= t('.table.nearly_one_year_contract_average_contract_period') -%></th>
          <th rowspan="2"><%= t('.table.proportion_of_contract_amount_modification_fee') -%></th>
          <th rowspan="2"><%= t('.table.proportion_of_labor_cost_of_bidding_land_acquisition') -%></th>
        </tr>
        <tr class="table-fix-head-row-2">
          <th><%= t('.table.last_year') -%></th>
          <th><%= t('.table.this_year') -%></th>
          <th><%= t('.table.scheme') -%></th>
          <th><%= t('.table.construction_drawing') -%></th>
          <th><%= t('.table.whole_process') -%></th>
        </tr>
      </thead>
      <tbody>
        <% @detail_data.each_with_index do |dd, index| %>
          <tr>
            <td><%= index + 1 -%></td>
            <td><%= link_to dd.crmshort, drill_down_dept_value_report_crm_year_report_path(crmcode: dd.crmcode, year: @year), remote: true -%></td>
            <td><%= dd.cricrank -%></td>
            <td><%= dd.clientproperty -%></td>
            <td><%= (dd.heji_last.to_f / 10000.0).round(0) -%></td>
            <td><%= (dd.heji.to_f / 10000.0).round(0) -%></td>
            <td><%= (dd.heji_per.to_f * 100.0).round(1) -%>%</td>
            <td><%= dd.topthreegroup -%></td>
            <td><%= (dd.designvalue.to_f / 10000.0).round(0) -%></td>
            <td><%= (dd.constructionvalue.to_f / 10000.0).round(0) -%></td>
            <td><%= (dd.fullvalue.to_f / 10000.0).round(0) -%></td>
            <td><%= (Bi::CrmClientOneYear.by_crmcode.fetch(dd.crmcode, nil)&.fetch(:avgamount, 0).to_f / 10000.0).round(0) -%></td>
            <td><%= (Bi::CrmClientOneYear.by_crmcode.fetch(dd.crmcode, nil)&.fetch(:avgarea, 0).to_f / 10000.0).round(0) -%></td>
            <td><%= Bi::CrmClientOneYear.by_crmcode.fetch(dd.crmcode, nil)&.fetch(:avgsignday, 0) -%></td>
            <td><%= (Bi::CrmClientOneYear.by_crmcode.fetch(dd.crmcode, nil)&.fetch(:contractalter, 0).to_f * 100.0).round(1) -%>%</td>
            <td><%= (Bi::CrmClientOneYear.by_crmcode.fetch(dd.crmcode, nil)&.fetch(:landhrcost, 0).to_f * 100.0).round(1) -%>%</td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>

<div id="crm-year-report-modal" class="modal" tabindex="-1" role="dialog"></div>
